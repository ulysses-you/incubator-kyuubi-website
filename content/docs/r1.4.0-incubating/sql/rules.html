

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>1. Auxiliary SQL extension for Spark SQL &mdash; Kyuubi 1.4.0-incubating documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2. Auxiliary SQL Functions for Spark SQL" href="functions.html" />
    <link rel="prev" title="SQL References" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Kyuubi
          

          
            
            <img src="../_static/kyuubi_logo_gray.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Usage Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/index.html">Deploying Kyuubi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/index.html">Client Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../integrations/index.html">Integrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monitor/index.html">Monitoring</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">SQL References</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">1. Auxiliary SQL extension for Spark SQL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-feature-does-kyuubi-sql-extension-provide">1.1. What feature does Kyuubi SQL extension provide</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-use-kyuubi-sql-extension">1.2. How to use Kyuubi SQL extension</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="functions.html">2. Auxiliary SQL Functions for Spark SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="z-order-benchmark.html">3. Z-order Benchmark</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Kyuubi Insider</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../develop_tools/index.html">Develop Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Community</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index.html">Appendixes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kyuubi</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">SQL References</a> &raquo;</li>
        
      <li><span class="section-number">1. </span>Auxiliary SQL extension for Spark SQL</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/sql/rules.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <!--
 - Licensed to the Apache Software Foundation (ASF) under one or more
 - contributor license agreements.  See the NOTICE file distributed with
 - this work for additional information regarding copyright ownership.
 - The ASF licenses this file to You under the Apache License, Version 2.0
 - (the "License"); you may not use this file except in compliance with
 - the License.  You may obtain a copy of the License at
 -
 -   http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
 --><div align=center><p><img alt="../_images/kyuubi_logo.png" src="../_images/kyuubi_logo.png" /></p>
</div><div class="section" id="auxiliary-sql-extension-for-spark-sql">
<h1><span class="section-number">1. </span>Auxiliary SQL extension for Spark SQL<a class="headerlink" href="#auxiliary-sql-extension-for-spark-sql" title="Permalink to this headline">¶</a></h1>
<p>Kyuubi provides SQL extension out of box. Due to the version compatibility with Apache Spark, currently we only support Apache Spark branch-3.1 (i.e 3.1.1 and 3.1.2).
And don’t worry, Kyuubi will support the new Apache Spark version in the future. Thanks to the adaptive query execution framework (AQE), Kyuubi can do these optimizations.</p>
<div class="section" id="what-feature-does-kyuubi-sql-extension-provide">
<h2><span class="section-number">1.1. </span>What feature does Kyuubi SQL extension provide<a class="headerlink" href="#what-feature-does-kyuubi-sql-extension-provide" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>merging small files automatically</p>
<p>Small files is a long time issue with Apache Spark. Kyuubi can merge small files by adding an extra shuffle.
Currently, Kyuubi supports handle small files with datasource table and hive table, and also Kyuubi support optimize dynamic partition insertion.
For example, a common write query <code class="docutils literal notranslate"><span class="pre">INSERT</span> <span class="pre">INTO</span> <span class="pre">TABLE</span> <span class="pre">$table1</span> <span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">$table2</span></code>, Kyuubi will introduce an extra shuffle before write and then the small files will go away.</p>
</li>
<li><p>insert shuffle node before Join to make AQE OptimizeSkewedJoin work</p>
<p>In current implementation, Apache Spark can only optimize skewed join by the standard join which means a join must have two sort and shuffle node.
However, in complex scenario this assuming will be broken easily. Kyuubi can guarantee the join is standard by adding an extra shuffle node before join.
So that, OptimizeSkewedJoin can work better.</p>
</li>
<li><p>stage level config isolation in AQE</p>
<p>As we know, <code class="docutils literal notranslate"><span class="pre">spark.sql.adaptive.advisoryPartitionSizeInBytes</span></code> is a key config in Apache Spark AQE.
It controls how big data size per-task should handle during shuffle, so we always use a 64MB or a smaller value to make parallelism enough.
However, in general, we expect a file is big enough like 256MB or 512MB. Kyuubi can make the config isolation to solve the conflict so that
we can make staging partition data size small and last partition data size big.</p>
</li>
</ul>
</div>
<div class="section" id="how-to-use-kyuubi-sql-extension">
<h2><span class="section-number">1.2. </span>How to use Kyuubi SQL extension<a class="headerlink" href="#how-to-use-kyuubi-sql-extension" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<thead>
<tr>
<th>Kyuubi Spark SQL extension</th>
<th>Supported Spark version(s)</th>
<th>Available since</th>
<th>EOL</th>
<th>Bundled in Binary release tarball</th>
<th>Maven profile</th>
</tr>
</thead>
<tbody>
<tr>
<td>kyuubi-extension-spark-3-1</td>
<td>3.1.x</td>
<td>1.3.0-incubating</td>
<td>N/A</td>
<td>1.3.0-incubating</td>
<td>spark-3.1</td>
</tr>
<tr>
<td>kyuubi-extension-spark-3-2</td>
<td>3.2.x</td>
<td>1.4.0-incubating</td>
<td>N/A</td>
<td>1.4.0-incubating</td>
<td>spark-3.2</td>
</tr>
</tbody>
</table><ol class="simple">
<li><p>Check the matrix that if you are using the supported Spark version, and find the corresponding Kyuubi Spark SQL Extension jar</p></li>
<li><p>Get the Kyuubi Spark SQL Extension jar</p>
<ol class="simple">
<li><p>Each Kyuubi binary release tarball only contains one default version of Kyuubi Spark SQL Extension jar, if you are looking for such version, you can find it under <code class="docutils literal notranslate"><span class="pre">$KYUUBI_HOME/extension</span></code></p></li>
<li><p>All supported versions of Kyuubi Spark SQL Extension jar will be deployed to <a class="reference external" href="https://search.maven.org/search?q=kyuubi-extension-spark">Maven Central</a></p></li>
<li><p>If you like, you can compile Kyuubi Spark SQL Extension jar by yourself, please activate the corresponding Maven’s profile on you compile command, i.e. you can get Kyuubi Spark SQL Extension jar for Spark 3.1 under <code class="docutils literal notranslate"><span class="pre">dev/kyuubi-extension-spark-3-1/target</span></code> when compile with <code class="docutils literal notranslate"><span class="pre">-Pspark-3.1</span></code></p></li>
</ol>
</li>
<li><p>Put the Kyuubi Spark SQL extension jar <code class="docutils literal notranslate"><span class="pre">kyuubi-extension-spark-*.jar</span></code> into <code class="docutils literal notranslate"><span class="pre">$SPARK_HOME/jars</span></code></p></li>
<li><p>Enable <code class="docutils literal notranslate"><span class="pre">KyuubiSparkSQLExtension</span></code>, i.e. add a config into <code class="docutils literal notranslate"><span class="pre">$SPARK_HOME/conf/spark-defaults.conf</span></code>, <code class="docutils literal notranslate"><span class="pre">spark.sql.extensions=org.apache.kyuubi.sql.KyuubiSparkSQLExtension</span></code></p></li>
</ol>
<p>Now, you can enjoy the Kyuubi SQL Extension, and also Kyuubi provides some configs to make these feature easy to use.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Name</th>
<th>Default Value</th>
<th>Description</th>
<th>Since</th>
</tr>
</thead>
<tbody>
<tr>
<td>spark.sql.optimizer.insertRepartitionBeforeWrite.enabled</td>
<td>true</td>
<td>Add repartition node at the top of query plan. An approach of merging small files.</td>
<td>1.2.0</td>
</tr>
<tr>
<td>spark.sql.optimizer.insertRepartitionNum</td>
<td>none</td>
<td>The partition number if <code>spark.sql.optimizer.insertRepartitionBeforeWrite.enabled</code> is enabled. If AQE is disabled, the default value is <code>spark.sql.shuffle.partitions</code>. If AQE is enabled, the default value is none that means depend on AQE.</td>
<td>1.2.0</td>
</tr>
<tr>
<td>spark.sql.optimizer.dynamicPartitionInsertionRepartitionNum</td>
<td>100</td>
<td>The partition number of each dynamic partition if <code>spark.sql.optimizer.insertRepartitionBeforeWrite.enabled</code> is enabled. We will repartition by dynamic partition columns to reduce the small file but that can cause data skew. This config is to extend the partition of dynamic partition column to avoid skew but may generate some small files.</td>
<td>1.2.0</td>
</tr>
<tr>
<td>spark.sql.optimizer.forceShuffleBeforeJoin.enabled</td>
<td>false</td>
<td>Ensure shuffle node exists before shuffled join (shj and smj) to make AQE <code>OptimizeSkewedJoin</code> works (complex scenario join, multi table join).</td>
<td>1.2.0</td>
</tr>
<tr>
<td>spark.sql.optimizer.finalStageConfigIsolation.enabled</td>
<td>false</td>
<td>If true, the final stage support use different config with previous stage. The prefix of final stage config key should be <code>spark.sql.finalStage.</code>. For example, the raw spark config: <code>spark.sql.adaptive.advisoryPartitionSizeInBytes</code>, then the final stage config should be: <code>spark.sql.finalStage.adaptive.advisoryPartitionSizeInBytes</code>.</td>
<td>1.2.0</td>
</tr>
<tr>
<td>spark.sql.analyzer.classification.enabled</td>
<td>false</td>
<td>When true, allows Kyuubi engine to judge this SQL's classification and set <code>spark.sql.analyzer.classification</code> back into sessionConf. Through this configuration item, Spark can optimizing configuration dynamic.</td>
<td>1.4.0</td>
</tr>
<tr>
<td>spark.sql.optimizer.insertZorderBeforeWriting.enabled</td>
<td>true</td>
<td>When true, we will follow target table properties to insert zorder or not. The key properties are: 1) <code>kyuubi.zorder.enabled</code>: if this property is true, we will insert zorder before writing data. 2) <code>kyuubi.zorder.cols</code>: string split by comma, we will zorder by these cols.</td>
<td>1.4.0</td>
</tr>
<tr>
<td>spark.sql.optimizer.zorderGlobalSort.enabled</td>
<td>true</td>
<td>When true, we do a global sort using zorder. Note that, it can cause data skew issue if the zorder columns have less cardinality. When false, we only do local sort using zorder.</td>
<td>1.4.0</td>
</tr>
<tr>
<td>spark.sql.watchdog.maxPartitions</td>
<td>none</td>
<td>Set the max partition number when spark scans a data source. Enable MaxPartitionStrategy by specifying this configuration. Add maxPartitions Strategy to avoid scan excessive partitions on partitioned table, it's optional that works with defined</td>
<td>1.4.0</td>
</tr>
</tbody>
</table></div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="functions.html" class="btn btn-neutral float-right" title="2. Auxiliary SQL Functions for Spark SQL" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="SQL References" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 
Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to You under the Apache License, Version 2.0
(the &#34;License&#34;); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>